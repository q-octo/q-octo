
#include <Adafruit_MCP2515.h>
#include "main.h"

#define CS_PIN 20
#define INT_PIN 21

// Set CAN bus baud rate
#define CAN_BAUDRATE (1000000)

Adafruit_MCP2515 mcp(CS_PIN);



void setup()
{
    Serial.begin(115200);
    while (!Serial)
        delay(10);

    Serial.println("MCP2515 Receiver Callback test!");

    if (!mcp.begin(CAN_BAUDRATE))
    {
        Serial.println("Error initializing MCP2515.");
        while (1)
            delay(10);
    }
    Serial.println("MCP2515 chip found");

    // register the receive callback
    mcp.onReceive(INT_PIN, onReceive);
}

void loop()
{
    // do nothing
}


void onReceive(int packetSize)
{
    // received a packet
    Serial.print("Received ");

    if (mcp.packetExtended())
    {
        Serial.print("extended ");
    }

    if (mcp.packetRtr())
    {
        // Remote transmission request, packet contains no data
        Serial.print("RTR ");
    }

    Serial.print("packet with id 0x");
    Serial.print(mcp.packetId(), HEX);

    if (mcp.packetRtr())
    {
        Serial.print(" and requested length ");
        Serial.println(mcp.packetDlc());
    }
    else
    {
        Serial.print(" and length ");
        Serial.println(packetSize);

        // only print packet data for non-RTR packets
        while (mcp.available())
        {
            Serial.print((char)mcp.read());
        }
        Serial.println();
    }

    Serial.println();
}